#define parameters
$prefix = "<%= @sitecore['prefix'] %>"
$PSScriptRoot = "<%= @sitecore['root'] %>"
$XConnectCollectionService = "$prefix.xconnect"
$sitecoreSiteName = "$prefix.local"
$SolrUrl = "<%= @sitecore['solr_url'] %>"
$SolrRoot = "<%= @sitecore['solr_root'] %>"
$SolrService = "<%= @sitecore['solr_service'] %>"
$SqlServer = "<%= @sitecore['sql_server'] %>"
$SqlAdminUser = "<%= @sitecore['sql_admin_user'] %>"
$SqlAdminPassword = "<%= @sitecore['sql_admin_password'] %>"

#install client certificate for xconnect
$xConnectCertParams =
@{
    Path = "$PSScriptRoot\xconnect-createcert.json"
    CertificateDnsName = "$prefix.xconnect"
    CertificateName = "$prefix.xconnect_client"
}
Install-SitecoreConfiguration @xConnectCertParams -Verbose

#install client certificate for sitecore
$sitecoreCertParams =
@{
    Path = "$PSScriptRoot\xconnect-createcert.json"
    CertificateDnsName = "$prefix.local"
    CertificateName = "$prefix.local_client"
}
Install-SitecoreConfiguration @sitecoreCertParams -Verbose

#install solr cores for xdb
$solrParams =
@{
    Path = "$PSScriptRoot\xconnect-solr.json"
    SolrUrl = $SolrUrl
    SolrRoot = $SolrRoot
    SolrService = $SolrService
    CorePrefix = $prefix
}
Install-SitecoreConfiguration @solrParams -Verbose

#deploy xconnect instance
$xconnectParams =
@{
    Path = "$PSScriptRoot\xconnect-xp0.json"
    Package = "$PSScriptRoot\Sitecore 9.0.1 rev. 171219 (OnPrem)_xp0xconnect.scwdp.zip"
    LicenseFile = "$PSScriptRoot\license.xml"
    Sitename = $XConnectCollectionService
    XConnectCert = $xConnectCertParams.CertificateDnsName
    SqlDbPrefix = $prefix
    SqlServer = $SqlServer
    SqlAdminUser = $SqlAdminUser
    SqlAdminPassword = $SqlAdminPassword
    SolrCorePrefix = $prefix
    SolrURL = $SolrUrl
}
Install-SitecoreConfiguration @xconnectParams -Verbose

#install solr cores for sitecore
$solrParams =
@{
    Path = "$PSScriptRoot\sitecore-solr.json"
    SolrUrl = $SolrUrl
    SolrRoot = $SolrRoot
    SolrService = $SolrService
    CorePrefix = $prefix
}
Install-SitecoreConfiguration @solrParams -Verbose

#install sitecore instance
$sitecoreParams =
@{
    Path = "$PSScriptRoot\sitecore-XP0.json"
    Package = "$PSScriptRoot\Sitecore 9.0.1 rev. 171219 (OnPrem)_single.scwdp.zip"
    LicenseFile = "$PSScriptRoot\license.xml"
    SqlDbPrefix = $prefix
    SqlServer = $SqlServer
    SqlAdminUser = $SqlAdminUser
    SqlAdminPassword = $SqlAdminPassword
    SolrCorePrefix = $prefix
    SolrUrl = $SolrUrl
    XConnectCert = $xConnectCertParams.CertificateDnsName
    SSLCert = $sitecoreCertParams.CertificateDnsName
    Sitename = $sitecoreSiteName
    XConnectCollectionService = "https://$XConnectCollectionService"
}
Install-SitecoreConfiguration @sitecoreParams -Verbose